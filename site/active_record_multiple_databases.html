<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Multiple Databases with Active Record — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/search.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/search.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr-documents.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/lunr.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Multiple Databases with Active Record — Ruby on Rails Guides" />
  <meta name="description" content="Multiple Databases with Active RecordThis guide covers using multiple databases with your Rails application.After reading this guide you will know: How to setup your application for multiple databases. How automatic connection switching works. What features are supported and what&#39;s still a work in progress." />
  <meta property="og:description" content="Multiple Databases with Active RecordThis guide covers using multiple databases with your Rails application.After reading this guide you will know: How to setup your application for multiple databases. How automatic connection switching works. What features are supported and what&#39;s still a work in progress." />
  <meta property="og:locale" content="pt_BR" />
  <meta property="og:site_name" content="Guia Ruby on Rails" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">Veja mais em <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        Mais Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guia oficial</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://stackoverflow.com/questions/tagged/ruby-on-rails">Peça por ajuda</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribua no GitHub</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="Voltar para a página principal">Guiarails.com.br</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">Home</a></li>
        <li class="guides-search guides-search-large">
          <input class="search-box search-box-large nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Guias</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <div class="guides-section-container">
                <div class="guides-section">
                  <dt>Comece aqui</dt>
                  <dd><a href="getting_started.html">Começando com Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record Basics</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                  <dd><a href="active_record_validations.html">Active Record Validations</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                  <dd><a href="association_basics.html">Active Record Associations</a></dd>
                  <dd><a href="active_record_querying.html">Active Record Query Interface</a></dd>
                  <dd><a href="active_model_basics.html">Active Model Basics</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="action_view_overview.html">Action View Overview</a></dd>
                  <dd><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></dd>
                  <dd><a href="form_helpers.html">Action View Form Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller Overview</a></dd>
                  <dd><a href="routing.html">Rails Routing from the Outside In</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Outros componentes</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer Basics</a></dd>
                  <dd><a href="action_mailbox_basics.html">Action Mailbox Basics</a></dd>
                  <dd><a href="action_text_overview.html">Action Text Overview</a></dd>
                  <dd><a href="active_job_basics.html">Active Job Basics</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage Overview</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable Overview</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Indo mais fundo</dt>
                  <dd><a href="i18n.html">Rails Internationalization (I18n) API</a></dd>
                  <dd><a href="testing.html">Testing Rails Applications</a></dd>
                  <dd><a href="security.html">Securing Rails Applications</a></dd>
                  <dd><a href="debugging_rails_applications.html">Debugging Rails Applications</a></dd>
                  <dd><a href="configuring.html">Configuring Rails Applications</a></dd>
                  <dd><a href="command_line.html">The Rails Command Line</a></dd>
                  <dd><a href="asset_pipeline.html">The Asset Pipeline</a></dd>
                  <dd><a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a></dd>
                  <dd><a href="initialization.html">The Rails Initialization Process</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants (Zeitwerk Mode)</a></dd>
                  <dd><a href="autoloading_and_reloading_constants_classic_mode.html">Autoloading and Reloading Constants (Classic Mode)</a></dd>
                  <dd><a href="caching_with_rails.html">Caching with Rails: An Overview</a></dd>
                  <dd><a href="active_support_instrumentation.html">Active Support Instrumentation</a></dd>
                  <dd><a href="api_app.html">Using Rails for API-only Applications</a></dd>
                  <dd><a href="active_record_postgresql.html">Active Record and PostgreSQL</a></dd>
                  <dd><a href="active_record_multiple_databases.html">Multiple Databases with Active Record</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Estendendo o Rails</dt>
                  <dd><a href="plugins.html">The Basics of Creating Rails Plugins</a></dd>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                  <dd><a href="engines.html">Getting Started with Engines</a></dd>
                  <dd><a href="threading_and_code_execution.html">Threading and Code Execution in Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Contribuições</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API Documentation Guidelines</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Políticas</dt>
                  <dd><a href="maintenance_policy.html">Maintenance Policy for Ruby on Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Release Notes</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</a></dd>
                  <dd><a href="6_0_release_notes.html">6.0 Release Notes - Agosto 2019</a></dd>
                  <dd><a href="5_2_release_notes.html">Version 5.2 - April 2018</a></dd>
                  <dd><a href="5_1_release_notes.html">Version 5.1 - April 2017</a></dd>
                  <dd><a href="5_0_release_notes.html">Version 5.0 - June 2016</a></dd>
                  <dd><a href="4_2_release_notes.html">Version 4.2 - December 2014</a></dd>
                  <dd><a href="4_1_release_notes.html">Version 4.1 - April 2014</a></dd>
                  <dd><a href="4_0_release_notes.html">Version 4.0 - June 2013</a></dd>
                  <dd><a href="3_2_release_notes.html">Version 3.2 - January 2012</a></dd>
                  <dd><a href="3_1_release_notes.html">Version 3.1 - August 2011</a></dd>
                  <dd><a href="3_0_release_notes.html">Version 3.0 - August 2010</a></dd>
                  <dd><a href="2_3_release_notes.html">Version 2.3 - March 2009</a></dd>
                  <dd><a href="2_2_release_notes.html">Version 2.2 - November 2008</a></dd>
                </div>
            </div>
          </div>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribua</a></li>
        <li class="guides-search guides-search-small">
          <input class="search-box search-box-small nav-item" type="text" placeholder="Digite o termo...">
          <div class="search-results"></div>
          <div class="search-spinner">Aguarde...</div>
        </li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Guias</option>
              <optgroup label="Comece aqui">
                  <option value="getting_started.html">Começando com Rails</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record Basics</option>
                  <option value="active_record_migrations.html">Active Record Migrations</option>
                  <option value="active_record_validations.html">Active Record Validations</option>
                  <option value="active_record_callbacks.html">Active Record Callbacks</option>
                  <option value="association_basics.html">Active Record Associations</option>
                  <option value="active_record_querying.html">Active Record Query Interface</option>
                  <option value="active_model_basics.html">Active Model Basics</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="action_view_overview.html">Action View Overview</option>
                  <option value="layouts_and_rendering.html">Layouts and Rendering in Rails</option>
                  <option value="form_helpers.html">Action View Form Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller Overview</option>
                  <option value="routing.html">Rails Routing from the Outside In</option>
              </optgroup>
              <optgroup label="Outros componentes">
                  <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                  <option value="action_mailer_basics.html">Action Mailer Basics</option>
                  <option value="action_mailbox_basics.html">Action Mailbox Basics</option>
                  <option value="action_text_overview.html">Action Text Overview</option>
                  <option value="active_job_basics.html">Active Job Basics</option>
                  <option value="active_storage_overview.html">Active Storage Overview</option>
                  <option value="action_cable_overview.html">Action Cable Overview</option>
              </optgroup>
              <optgroup label="Indo mais fundo">
                  <option value="i18n.html">Rails Internationalization (I18n) API</option>
                  <option value="testing.html">Testing Rails Applications</option>
                  <option value="security.html">Securing Rails Applications</option>
                  <option value="debugging_rails_applications.html">Debugging Rails Applications</option>
                  <option value="configuring.html">Configuring Rails Applications</option>
                  <option value="command_line.html">The Rails Command Line</option>
                  <option value="asset_pipeline.html">The Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">Working with JavaScript in Rails</option>
                  <option value="initialization.html">The Rails Initialization Process</option>
                  <option value="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants (Zeitwerk Mode)</option>
                  <option value="autoloading_and_reloading_constants_classic_mode.html">Autoloading and Reloading Constants (Classic Mode)</option>
                  <option value="caching_with_rails.html">Caching with Rails: An Overview</option>
                  <option value="active_support_instrumentation.html">Active Support Instrumentation</option>
                  <option value="api_app.html">Using Rails for API-only Applications</option>
                  <option value="active_record_postgresql.html">Active Record and PostgreSQL</option>
                  <option value="active_record_multiple_databases.html">Multiple Databases with Active Record</option>
              </optgroup>
              <optgroup label="Estendendo o Rails">
                  <option value="plugins.html">The Basics of Creating Rails Plugins</option>
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
                  <option value="engines.html">Getting Started with Engines</option>
                  <option value="threading_and_code_execution.html">Threading and Code Execution in Rails</option>
              </optgroup>
              <optgroup label="Contribuições">
                  <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API Documentation Guidelines</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</option>
              </optgroup>
              <optgroup label="Políticas">
                  <option value="maintenance_policy.html">Maintenance Policy for Ruby on Rails</option>
              </optgroup>
              <optgroup label="Release Notes">
                  <option value="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</option>
                  <option value="6_0_release_notes.html">6.0 Release Notes - Agosto 2019</option>
                  <option value="5_2_release_notes.html">Version 5.2 - April 2018</option>
                  <option value="5_1_release_notes.html">Version 5.1 - April 2017</option>
                  <option value="5_0_release_notes.html">Version 5.0 - June 2016</option>
                  <option value="4_2_release_notes.html">Version 4.2 - December 2014</option>
                  <option value="4_1_release_notes.html">Version 4.1 - April 2014</option>
                  <option value="4_0_release_notes.html">Version 4.0 - June 2013</option>
                  <option value="3_2_release_notes.html">Version 3.2 - January 2012</option>
                  <option value="3_1_release_notes.html">Version 3.1 - August 2011</option>
                  <option value="3_0_release_notes.html">Version 3.0 - August 2010</option>
                  <option value="2_3_release_notes.html">Version 2.3 - March 2009</option>
                  <option value="2_2_release_notes.html">Version 2.2 - November 2008</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Multiple Databases with Active Record</h2><p>This guide covers using multiple databases with your Rails application.</p><p>After reading this guide you will know:</p>
<ul>
<li>How to setup your application for multiple databases.</li>
<li>How automatic connection switching works.</li>
<li>What features are supported and what&#39;s still a work in progress.</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#setting-up-your-application">Setting up your application</a></li>
<li><a href="#migrations">Migrations</a></li>
<li><a href="#activating-automatic-connection-switching">Activating automatic connection switching</a></li>
<li><a href="#using-manual-connection-switching">Using manual connection switching</a></li>
<li>
<a href="#caveats">Caveats</a>

<ul>
<li><a href="#sharding">Sharding</a></li>
<li><a href="#load-balancing-replicas">Load Balancing Replicas</a></li>
<li><a href="#joining-across-databases">Joining Across Databases</a></li>
<li><a href="#schema-cache">Schema Cache</a></li>
</ul>
</li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <p>As an application grows in popularity and usage you'll need to scale the application
to support your new users and their data. One way in which your application may need
to scale is on the database level. Rails now has support for multiple databases
so you don't have to store your data all in one place.</p><p>At this time the following features are supported:</p>
<ul>
<li>Multiple primary databases and a replica for each</li>
<li>Automatic connection switching for the model you're working with</li>
<li>Automatic swapping between the primary and replica depending on the HTTP verb
and recent writes</li>
<li>Rails tasks for creating, dropping, migrating, and interacting with the multiple
databases</li>
</ul>
<p>The following features are not (yet) supported:</p>
<ul>
<li>Sharding</li>
<li>Joining across clusters</li>
<li>Load balancing replicas</li>
<li>Dumping schema caches for multiple databases</li>
</ul>
<h3 id="setting-up-your-application"><a class="anchorlink" href="#setting-up-your-application">1 Setting up your application</a></h3><p>While Rails tries to do most of the work for you there are still some steps you'll
need to do to get your application ready for multiple databases.</p><p>Let's say we have an application with a single primary database and we need to add a
new database for some new tables we're adding. The name of the new database will be
"animals".</p><p>The <code>database.yml</code> looks like this:</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">production</span><span class="pi">:</span>
  <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_database</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">root</span>
  <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b3a7a003238bd914d5edc4b569e6a09f">production:
  database: my_primary_database
  user: root
  adapter: mysql
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b3a7a003238bd914d5edc4b569e6a09f">Copiar</button>
</div>
<p>Let's add a replica for the primary, a new writer called animals and a replica for that
as well. To do this we need to change our <code>database.yml</code> from a 2-tier to a 3-tier config.</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">production</span><span class="pi">:</span>
  <span class="na">primary</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_database</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">root</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">primary_replica</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_database</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">root_readonly</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql</span>
    <span class="na">replica</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">animals</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_animals_database</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">animals_root</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql</span>
    <span class="na">migrations_paths</span><span class="pi">:</span> <span class="s">db/animals_migrate</span>
  <span class="na">animals_replica</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_animals_database</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">animals_readonly</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql</span>
    <span class="na">replica</span><span class="pi">:</span> <span class="no">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8dbebd16b2e1f71bc9294634a91d3343">production:
  primary:
    database: my_primary_database
    user: root
    adapter: mysql
  primary_replica:
    database: my_primary_database
    user: root_readonly
    adapter: mysql
    replica: true
  animals:
    database: my_animals_database
    user: animals_root
    adapter: mysql
    migrations_paths: db/animals_migrate
  animals_replica:
    database: my_animals_database
    user: animals_readonly
    adapter: mysql
    replica: true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8dbebd16b2e1f71bc9294634a91d3343">Copiar</button>
</div>
<p>When using multiple databases there are a few important settings.</p><p>First, the database name for the primary and replica should be the same because they contain
the same data. Second, the username for the primary and replica should be different, and the
replica user's permissions should be to read and not write.</p><p>When using a replica database you need to add a <code>replica: true</code> entry to the replica in the
<code>database.yml</code>. This is because Rails otherwise has no way of knowing which one is a replica
and which one is the primary.</p><p>Lastly, for new primary databases you need to set the <code>migrations_paths</code> to the directory
where you will store migrations for that database. We'll look more at <code>migrations_paths</code>
later on in this guide.</p><p>Now that we have a new database, let's set up the model. In order to use the new database we
need to create a new abstract class and connect to the animals databases.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AnimalsBase</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="n">connects_to</span> <span class="ss">database: </span><span class="p">{</span> <span class="ss">writing: :animals</span><span class="p">,</span> <span class="ss">reading: :animals_replica</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8292795854a251971b6e6b0126777da3">class AnimalsBase &lt; ApplicationRecord
  self.abstract_class = true

  connects_to database: { writing: :animals, reading: :animals_replica }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8292795854a251971b6e6b0126777da3">Copiar</button>
</div>
<p> Then we need to
update <code>ApplicationRecord</code> to be aware of our new replica.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationRecord</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="n">connects_to</span> <span class="ss">database: </span><span class="p">{</span> <span class="ss">writing: :primary</span><span class="p">,</span> <span class="ss">reading: :primary_replica</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0df57cf491984449ef3929f67df78789">class ApplicationRecord &lt; ActiveRecord::Base
  self.abstract_class = true

  connects_to database: { writing: :primary, reading: :primary_replica }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0df57cf491984449ef3929f67df78789">Copiar</button>
</div>
<p>By default Rails expects the database roles to be <code>writing</code> and <code>reading</code> for the primary
and replica respectively. If you have a legacy system you may already have roles set up that
you don't want to change. In that case you can set a new role name in your application config.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">writing_role</span> <span class="o">=</span> <span class="ss">:default</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">reading_role</span> <span class="o">=</span> <span class="ss">:readonly</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-08155e4795f4ee3bc9874693f47c4963">config.active_record.writing_role = :default
config.active_record.reading_role = :readonly
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-08155e4795f4ee3bc9874693f47c4963">Copiar</button>
</div>
<p>It's important to connect to your database in a single model and then inherit from that model
for the tables rather than connect multiple individual models to the same database. Database
clients have a limit to the number of open connections there can be and if you do this it will
multiply the number of connections you have since Rails uses the model class name for the
connection specification name.</p><p>Now that we have the <code>database.yml</code> and the new model set up it's time to create the databases.
Rails 6.0 ships with all the rails tasks you need to use multiple databases in Rails.</p><p>You can run <code>rails -T</code> to see all the commands you're able to run. You should see the following:</p><div class="code_container">
<pre><code class="highlight plaintext">$ rails -T
rails db:create                          # Creates the database from DATABASE_URL or config/database.yml for the ...
rails db:create:animals                  # Create animals database for current environment
rails db:create:primary                  # Create primary database for current environment
rails db:drop                            # Drops the database from DATABASE_URL or config/database.yml for the cu...
rails db:drop:animals                    # Drop animals database for current environment
rails db:drop:primary                    # Drop primary database for current environment
rails db:migrate                         # Migrate the database (options: VERSION=x, VERBOSE=false, SCOPE=blog)
rails db:migrate:animals                 # Migrate animals database for current environment
rails db:migrate:primary                 # Migrate primary database for current environment
rails db:migrate:status                  # Display status of migrations
rails db:migrate:status:animals          # Display status of migrations for animals database
rails db:migrate:status:primary          # Display status of migrations for primary database
</code></pre>
<textarea class="clipboard-content" id="clipboard-77067ff6d21c200ae5912a879b715ba0">$ rails -T
rails db:create                          # Creates the database from DATABASE_URL or config/database.yml for the ...
rails db:create:animals                  # Create animals database for current environment
rails db:create:primary                  # Create primary database for current environment
rails db:drop                            # Drops the database from DATABASE_URL or config/database.yml for the cu...
rails db:drop:animals                    # Drop animals database for current environment
rails db:drop:primary                    # Drop primary database for current environment
rails db:migrate                         # Migrate the database (options: VERSION=x, VERBOSE=false, SCOPE=blog)
rails db:migrate:animals                 # Migrate animals database for current environment
rails db:migrate:primary                 # Migrate primary database for current environment
rails db:migrate:status                  # Display status of migrations
rails db:migrate:status:animals          # Display status of migrations for animals database
rails db:migrate:status:primary          # Display status of migrations for primary database
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-77067ff6d21c200ae5912a879b715ba0">Copiar</button>
</div>
<p>Running a command like <code>rails db:create</code> will create both the primary and animals databases.
Note that there is no command for creating the users and you'll need to do that manually
to support the readonly users for your replicas. If you want to create just the animals
database you can run <code>rails db:create:animals</code>.</p><h3 id="migrations"><a class="anchorlink" href="#migrations">2 Migrations</a></h3><p>Migrations for multiple databases should live in their own folders prefixed with the
name of the database key in the configuration.</p><p>You also need to set the <code>migrations_paths</code> in the database configurations to tell Rails
where to find the migrations.</p><p>For example the <code>animals</code> database would look in the <code>db/animals_migrate</code> directory and
<code>primary</code> would look in <code>db/migrate</code>. Rails generators now take a <code>--database</code> option
so that the file is generated in the correct directory. The command can be run like so:</p><div class="code_container">
<pre><code class="highlight plaintext">$ rails g migration CreateDogs name:string --database animals
</code></pre>
<textarea class="clipboard-content" id="clipboard-805d11275e1a164e1879747f6a6abd04">$ rails g migration CreateDogs name:string --database animals
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-805d11275e1a164e1879747f6a6abd04">Copiar</button>
</div>
<h3 id="activating-automatic-connection-switching"><a class="anchorlink" href="#activating-automatic-connection-switching">3 Activating automatic connection switching</a></h3><p>Finally, in order to use the read-only replica in your application you'll need to activate
the middleware for automatic switching.</p><p>Automatic switching allows the application to switch from the primary to replica or replica
to primary based on the HTTP verb and whether there was a recent write.</p><p>If the application is receiving a POST, PUT, DELETE, or PATCH request the application will
automatically write to the primary. For the specified time after the write the application
will read from the primary. For a GET or HEAD request the application will read from the
replica unless there was a recent write.</p><p>To activate the automatic connection switching middleware, add or uncomment the following
lines in your application config.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_selector</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">delay: </span><span class="mi">2</span><span class="p">.</span><span class="nf">seconds</span> <span class="p">}</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_resolver</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">DatabaseSelector</span><span class="o">::</span><span class="no">Resolver</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_resolver_context</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">DatabaseSelector</span><span class="o">::</span><span class="no">Resolver</span><span class="o">::</span><span class="no">Session</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-10cedf2460db1f5a4701f6379fbae72e">config.active_record.database_selector = { delay: 2.seconds }
config.active_record.database_resolver = ActiveRecord::Middleware::DatabaseSelector::Resolver
config.active_record.database_resolver_context = ActiveRecord::Middleware::DatabaseSelector::Resolver::Session
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-10cedf2460db1f5a4701f6379fbae72e">Copiar</button>
</div>
<p>Rails guarantees "read your own write" and will send your GET or HEAD request to the
primary if it's within the <code>delay</code> window. By default the delay is set to 2 seconds. You
should change this based on your database infrastructure. Rails doesn't guarantee "read
a recent write" for other users within the delay window and will send GET and HEAD requests
to the replicas unless they wrote recently.</p><p>The automatic connection switching in Rails is relatively primitive and deliberately doesn't
do a whole lot. The goal was a system that demonstrated how to do automatic connection
switching that was flexible enough to be customizable by app developers.</p><p>The setup in Rails allows you to easily change how the switching is done and what
parameters it's based on. Let's say you want to use a cookie instead of a session to
decide when to swap connections. You can write your own class:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">MyCookieResolver</span>
  <span class="c1"># code for your cookie class</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-bb39371f3243a3c79b8178465db2adf0">class MyCookieResolver
  # code for your cookie class
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-bb39371f3243a3c79b8178465db2adf0">Copiar</button>
</div>
<p>And then pass it to the middleware:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_selector</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">delay: </span><span class="mi">2</span><span class="p">.</span><span class="nf">seconds</span> <span class="p">}</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_resolver</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">DatabaseSelector</span><span class="o">::</span><span class="no">Resolver</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_resolver_context</span> <span class="o">=</span> <span class="no">MyCookieResolver</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8a274b415e3b993c54bd5517c343cb3e">config.active_record.database_selector = { delay: 2.seconds }
config.active_record.database_resolver = ActiveRecord::Middleware::DatabaseSelector::Resolver
config.active_record.database_resolver_context = MyCookieResolver
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8a274b415e3b993c54bd5517c343cb3e">Copiar</button>
</div>
<h3 id="using-manual-connection-switching"><a class="anchorlink" href="#using-manual-connection-switching">4 Using manual connection switching</a></h3><p>There are some cases where you may want your application to connect to a primary or a replica
and the automatic connection switching isn't adequate. For example, you may know that for a
particular request you always want to send the request to a replica, even when you are in a
POST request path.</p><p>To do this Rails provides a <code>connected_to</code> method that will switch to the connection you
need.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">)</span> <span class="k">do</span>
  <span class="c1"># all code in this block will be connected to the reading role</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-41a17f7c7f9bb23656c92fa04727d7d2">ActiveRecord::Base.connected_to(role: :reading) do
  # all code in this block will be connected to the reading role
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-41a17f7c7f9bb23656c92fa04727d7d2">Copiar</button>
</div>
<p>The "role" in the <code>connected_to</code> call looks up the connections that are connected on that
connection handler (or role). The <code>reading</code> connection handler will hold all the connections
that were connected via <code>connects_to</code> with the role name of <code>reading</code>.</p><p>Note that <code>connected_to</code> with a role will look up an existing connection and switch
using the connection specification name. This means that if you pass an unknown role
like <code>connected_to(role: :nonexistent)</code> you will get an error that says
<code>ActiveRecord::ConnectionNotEstablished (No connection pool with 'AnimalsBase' found
for the 'nonexistent' role.)</code></p><h3 id="caveats"><a class="anchorlink" href="#caveats">5 Caveats</a></h3><h4 id="sharding"><a class="anchorlink" href="#sharding">5.1 Sharding</a></h4><p>As noted at the top, Rails doesn't (yet) support sharding. We had to do a lot of work
to support multiple databases for Rails 6.0. The lack of support for sharding isn't
an oversight, but does require additional work that didn't make it in for 6.0. For now
if you need sharding it may be advisable to continue using one of the many gems
that supports this.</p><h4 id="load-balancing-replicas"><a class="anchorlink" href="#load-balancing-replicas">5.2 Load Balancing Replicas</a></h4><p>Rails also doesn't support automatic load balancing of replicas. This is very
dependent on your infrastructure. We may implement basic, primitive load balancing
in the future, but for an application at scale this should be something your application
handles outside of Rails.</p><h4 id="joining-across-databases"><a class="anchorlink" href="#joining-across-databases">5.3 Joining Across Databases</a></h4><p>Applications cannot join across databases. Rails 6.1 will support using <code>has_many</code>
relationships and creating 2 queries instead of joining, but Rails 6.0 will require
you to split the joins into 2 selects manually.</p><h4 id="schema-cache"><a class="anchorlink" href="#schema-cache">5.4 Schema Cache</a></h4><p>If you use a schema cache and multiple databases you'll need to write an initializer
that loads the schema cache from your app. This wasn't an issue we could resolve in
time for Rails 6.0 but hope to have it in a future version soon.</p>

        <h3>Feedback</h3>
        <p>
          Você é incentivado a ajudar a melhorar a qualidade deste guia.
        </p>
        <p>
          Por favor, contribua se vir qualquer erros, inclusive erros de digitação.
          Para começar, você pode ler nossa sessão de <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">contribuindo com a documentação</a>.
        </p>
        <p>
          Você também pode encontrar conteúdo incompleto ou coisas que não estão atualizadas.
          Por favor, adicione qualquer documentação em falta na master do Rails. Certifique-se de checar o
          <a href="http://edgeguides.rubyonrails.org">Edge Guides (en-US)</a> primeiro para verificar
          se o problema já foi resolvido ou não no branch master.
          Verifique as <a href="ruby_on_rails_guides_guidelines.html">Diretrizes do Guia Ruby on Rails</a>
          para estilo e convenções.
        </p>
        <p>
          Se, por qualquer motivo, você encontrar algo para consertar, mas não conseguir consertá-lo, por favor
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">abra uma issue no nosso Guia</a>.
        </p>
        <p>
          E por último, mas não menos importante, qualquer tipo de discussão sobre a documentação do Ruby on Rails
          é muito bem vinda na <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">lista de discussão rubyonrails-docs</a> e nas
          <a href="https://github.com/campuscode/rails-guides-pt-BR/issues">issues do Guia em português</a>.
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p> Este projeto está licenciado sob uma licença <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a></p>
<p>"Rails", "Ruby on Rails", e o logotipo Rails são marcas comerciais de David Heinemeier Hansson. Todos os direitos reservados.</p>

    </div>
  </div>
</body>
</html>
